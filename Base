#!/bin/bash
set -ouexv pipefail

rm -rf /etc/yum.repos.d/fedora-cisco-openh264.repo

# System auto updates
sed -i 's/#AutomaticUpdatePolicy=none/AutomaticUpdatePolicy=stage/' /etc/rpm-ostreed.conf 
systemctl enable rpm-ostreed-automatic.timer || true 


# /*
# Configure Updates
# */
#sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/bootc update --quiet|' /usr/lib/systemd/system/bootc-fetch-apply-updates.service
#sed -i 's|^OnUnitInactiveSec=.*|OnUnitInactiveSec=7d\nPersistent=true|' /usr/lib/systemd/system/bootc-fetch-apply-updates.timer
#sed -i 's|#AutomaticUpdatePolicy.*|AutomaticUpdatePolicy=stage|' /etc/rpm-ostreed.conf
#sed -i 's|#LockLayering.*|LockLayering=true|' /etc/rpm-ostreed.conf
cat /usr/lib/systemd/system/bootc-fetch-apply-updates.service
cat /usr/lib/systemd/system/bootc-fetch-apply-updates.timer


# Disable the automatic reboot on the update service for bootc
#mkdir -p /etc/systemd/system/bootc-fetch-apply-updates.service.d
#cat << EOF > /etc/systemd/system/bootc-fetch-apply-updates.service.d/10-no-apply.conf
#[Service]
#ExecStart=
#ExecStart=/usr/bin/bootc update --quiet
#EOF



# Tailscale
dnf install -y --setopt=install_weak_deps=False --nogpgcheck --skip-unavailable tailscale 
systemctl enable tailscaled.service || true 

# SSH
systemctl enable sshd.service || true 

# Cockpit - basic only
dnf install -y --setopt=install_weak_deps=False --nogpgcheck --skip-unavailable cockpit #cockpit-machines cockpit-podman cockpit-files cockpit-navigator cockpit-selinux
systemctl enable cockpit.socket || true

# Common packages
dnf install -y --setopt=install_weak_deps=False --nogpgcheck --skip-unavailable git
dnf install -y --setopt=install_weak_deps=False --nogpgcheck --skip-unavailable rsync

# Toolbox to Distrobox
dnf install -y --setopt=install_weak_deps=False --nogpgcheck --skip-unavailable distrobox
#dnf remove -y toolbox

# Repo cleanup
#rm -rf /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:phracek:PyCharm.repo
#rm -rf /etc/yum.repos.d/fedora-cisco-openh264.repo
#rm -rf /etc/yum.repos.d/google-chrome.repo
#rm -rf /etc/yum.repos.d/rpmfusion-nonfree-nvidia-driver.repo
#rm -rf /etc/yum.repos.d/rpmfusion-nonfree-steam.repo
# DNF auto updates
#sed -i 's/#AutomaticUpdatePolicy=none/AutomaticUpdatePolicy=stage/' /etc/rpm-ostreed.conf
#systemctl enable rpm-ostreed-automatic.timer || true
#dnf -y install tailscale git
#systemctl enable tailscaled.service || true
#systemctl enable sshd.service || true
# Debloat
#dnf -y remove firefox* gnome-shell-extension* gnome-tour yelp* gnome-software-rpm-ostree virtualbox-guest-additions malcontent-control fedora-chromium-config*
